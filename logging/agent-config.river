logging {
  level  = "info"
}

loki.write "default" {
    endpoint {
        url = "http://loki:3100/loki/api/v1/push"
    }
}

local.file_match "backend" {
  path_targets = [
    { path = "/var/log/myapp/backend/*.log" },
  ]
}

local.file_match "chaincode" {
  path_targets = [
    { path = "/var/log/myapp/chaincode/*.log" },
  ]
}

loki.source.file "backend_logs" {
  targets    = local.file_match.backend.targets
  forward_to = [loki.write.default.receiver]
}

loki.process "backend" {
  stage.json {
    expressions = {
      timestamp     = "timestamp",
      level         = "level",
      correlationId = "correlationId",
      userId        = "userId",
      action        = "action",
      method        = "method",
    }
  }

  stage.labels {
    values = {
      source        = "backend",
      level         = "${level}",
      correlationId = "${correlationId}",
      userId        = "${userId}",
      action        = "${action}",
      method        = "${method}",
    }
  }

  forward_to = [loki.relabel.backend.receiver]
}

loki.relabel "backend" {
  forward_to = [loki.write.default.receiver]

  rule {
        action       = "replace"
        target_label = "job"
        replacement  = "backend"
  }
}

loki.source.file "chaincode_logs" {
  targets    = local.file_match.chaincode.targets
  forward_to = [loki.write.default.receiver]
}

loki.process "chaincode" {
  stage.json {
    expressions = {
      timestamp     = "timestamp",
      level         = "level",
      correlationId = "correlationId",
      userId        = "userId",
      action        = "action",
      method        = "method",
      channel       = "channel",
      txid          = "txid",
    }
  }

  stage.labels {
    values = {
      source        = "chaincode",
      level         = "${level}",
      correlationId = "${correlationId}",
      userId        = "${userId}",
      action        = "${action}",
      method        = "${method}",
      channel       = "${channel}",
      txid          = "${txid}",
    }
  }

  forward_to = [loki.relabel.chaincode.receiver]
}

loki.relabel "chaincode" {
  forward_to = [loki.write.default.receiver]

  rule {
        action       = "replace"
        target_label = "job"
        replacement  = "chaincode"
  }
}
